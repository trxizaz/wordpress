"use strict";!function(){let e=function(e){let t,i=document.querySelector(e);if(!i)return;return t=i.innerText,i.parentNode.removeChild(i),t}("#template-comparison");e&&(window.Comparison=function(){let t=null,i=null,n=null,a=null,r=null,s=null;function o(e){let t=Math.floor(Math.log(e)/Math.log(1024));return 1*(e/Math.pow(1024,t)).toFixed(2==t?1:0)+" "+["B","KB","MB"][t]}return new Bind({template:e,data:{quality:0,item:{},size_optimized:0,isPreview:!1,divider:.5,optimized_loaded:!1,original_loaded:!1,disable_range:!0,cursorMove:!1},computed:{size_original:function(){return this.item.size},size_human_original:function(){return o(this.size_original)},size_human_optimized:function(){return o(this.size_optimized)},savings:function(){return Math.round(100*(1-this.size_optimized/this.item.size))},range_type:function(){if(this.item.response)return this.item.response.hasOwnProperty("compressed_colors")?"colors":"quality"},range_min:function(){return this.item.response?this.item.response.params[this.range_type+"_min"]:0},range_max:function(){return this.item.response?this.item.response.params[this.range_type+"_max"]:100}},methods:{onInputChange:function(e){t.value=e.target.value,this.quality!=t.value&&(this.quality=t.value,i.value=this.quality,this.compress())},proceed:function(e){function t(e){this.item.id==e.fid&&this.setImage("optimized",appSettings.origin+e.compressed_url,{id:e&&e.fid,successCallback:n.bind(this,e)})}function i(e){"abort"!=e&&app.notify(appText.error,this.item.name),this.optimized_loaded=!0,this.disable_range=!this.original_loaded}function n(t){let i="compress"==e;this.quality=t[(i?"compressed_":"optimized_")+this.range_type],this.size_optimized=t.compressed_size,this.isPreview=i}this.disable_range=!0,"compress"==e?a=app.preview(this.item).onLoad(t.bind(this)).onError(i.bind(this)).onFinal((function(){a=null})):app.process(this.item,"optimize").onLoad(t.bind(this)).onError(i.bind(this))},compress:function(){this.proceed("compress")},optimize:function(){this.proceed("optimize")},setImage:function(e,t,i){let a="original"==e?"optimized":"original",r=new Image;function o(){this[e+"_loaded"]=!0,this.disable_range=!this[a+"_loaded"],app.notify(appText.error,this.item.name),i&&i.errorCallback&&i.errorCallback()}i&&this.item&&this.item.id!=i.id||(r.addEventListener("load",function(t){if(i&&this.item&&this.item.id!=i.id)return;this[e+"_loaded"]=!0,this.disable_range=!this[a+"_loaded"],n.setImage(e,t),i&&i.successCallback&&i.successCallback()}.bind(this,r)),r.addEventListener("error",o.bind(this)),GifFrames&&this.isGif()?s.setImage(e,t,{id:i&&i.id,successCallback:function(e){r.src=e},errorCallback:o.bind(this)}):(GifFrames&&s&&s.clear(),r.src="string"==typeof t?t:t[0]))},isGif:function(){return this.item.file&&"gif"==this.item.file.type.slice(-3).toLowerCase()}},mounted:function(){let e=this;i=this.elem.querySelector("#quality"),t=this.elem.querySelector(".quality__range-input"),n=ImageComparison(this.elem.querySelector("#canvas"),(function(){e.cursorMove=this.imageSmallerCanvas})),r=new Thumb(this.elem.querySelector("#thumb")),new InputNumber(i),new InputRange(t,(function(){i.value=this.value}),function(){this.quality=t.value,this.compress()}.bind(this)),s="undefined"!=typeof GifFrames?new GifFrames:{},GifFrames&&s&&(s.parent=this,s.disabled=this.disable_range,this.elem.querySelector("#frameControlSlot").appendChild(s.elem))},watch:{item:function(e){a&&a.abort(),e?(this._compute("range_type"),this._compute("range_min"),this._compute("range_max"),this.optimized_loaded=!1,this.original_loaded=!1,this.disable_range=!0,this.size_optimized=this.item.response.compressed_size,this.quality=this.item.response["compressed_"+this.range_type],this.divider=.5,this.isPreview=!1,n.clear(),n.resize(),r.update(),this.item.url&&this.setImage("original",[this.item.url,appSettings.origin+this.item.response.original_url],{id:this.item.id}),this.item.response.optimized_url&&this.setImage("optimized",appSettings.origin+this.item.response.optimized_url,{id:this.item.response.fid})):this.item={response:{params:{}}}},quality:function(e){this.range_type&&(app.convertParams[this.range_type]=this.quality)},divider:function(){n.draw()},disable_range:function(e){s.disabled=e}}})})}(),function(){let e=function(e){let t,i=document.querySelector(e);if(!i)return;return t=i.innerText,i.parentNode.removeChild(i),t}("#template-frame-control");e&&(window.GifFrames=function(){let t=-1;const i=new Bind({template:e,data:{original:{},optimized:{},parent:null,length:0,frame:0,disabled:!1,scriptState:-1,waitingFn:[]},computed:{hidden:function(){return this.length<=1}},methods:{setImage:function(e,t,i){if("original"==e&&this.clear(),-1==this.scriptState&&this.loadScript(),this.scriptState<1)return void this.waitingFn.push([e,t,Object.assign({},i)]);const n=this;!function a(r){n[e].explorer.setFile(r).then((function(t){return n[e].data=t,n[e].id=i&&i.id,n[e].callback=i&&i.successCallback,n[e].explorer.readInfo()})).then((function(t){return n.length!=t.images.length&&(n.length=t.images.length,n.frame=0),n[e].explorer.readImage(n.frame)})).then((function(t){n[e].callback&&n[e].callback(n.dataToImage(t))})).catch((function(e){"string"!=typeof t&&t.length>1?a(t[1]):(console.log(e),i&&i.errorCallback(e))}))}("string"==typeof t?t:t[0])},getInputWidth:function(e){return(12*e||2)+"px"},clear:function(){this.length=0,["original","optimized"].forEach(function(e){this[e].id=null,this[e].data&&delete this[e].data,this[e].data=null,this[e].toc&&delete this[e].toc,this[e].toc=null,"undefined"!=typeof GifReader&&(this[e].explorer instanceof GifReader?this[e].explorer.clear():this[e].explorer=new GifReader(appSettings.gif.workerSrc,appSettings.gif.polyfillSrc))}.bind(this))},onInputChange:function(e){let i=(e.target.value||1)-1;i=i>=this.length?this.length-1:i,i=i<=0?0:i,this.frame=i,-1==t&&requestAnimationFrame(this.checkStepChange.bind(this)),t=performance.now(),e.target.value=this.frame+1},step:function(e){let i=this.frame+e;i<0&&(i%=this.length,i+=this.length),i>=this.length&&(i%=this.length),this.frame=i,-1==t&&requestAnimationFrame(this.checkStepChange.bind(this)),t=performance.now()},dataToImage:function(e){let t=document.createElement("canvas"),i=t.getContext("2d");return t.width=e.width,t.height=e.height,i.putImageData(e,0,0),t.toDataURL()},checkStepChange:function(){if(performance.now()-t<375)return void requestAnimationFrame(this.checkStepChange.bind(this));let e={original:!1,optimized:!1};t=-1;for(let t in e){let a=t;i[a].explorer.readImage(i.frame).then((function(t){let i=null;try{i=new ImageData(t.data.slice(0,t.data.byteLength),t.width,t.height)}catch(e){i=new ImageData(t.data,t.width,t.height)}try{delete t.data}catch(e){}e[a]=i,n()}))}function n(){e.original&&e.optimized&&(i.original.callback&&i.original.callback(i.dataToImage(e.original)),i.optimized.callback&&i.optimized.callback(i.dataToImage(e.optimized)),delete e.original,delete e.optimized)}},loadScript:function(){if(this.scriptState>-1)return;let e=document.createElement("script");e.async=!0,e.addEventListener("load",function(){this.scriptState=1}.bind(this)),e.addEventListener("error",function(){this.scriptState=-1}.bind(this)),e.addEventListener("readystatechange",function(){if("loaded"!=e.readyState&&"completed"!=e.readyState)return;this.scriptState=1}.bind(this)),e.src=appSettings.gif.src,document.body.appendChild(e),this.scriptState=0}},watch:{scriptState:function(e){if(!(e<1)){this.clear();for(let e in this.waitingFn)this.setImage.apply(this,this.waitingFn[e]);this.waitingFn.splice(0,this.waitingFn.length)}}},mounted:function(){new InputNumber(this.elem.querySelector("#counter"))}});return i})}(),window.InputRange=function(e,t,i){const n=window.matchMedia("(max-width: 555px)"),a=700,r={last:-a,id:-1},s=!!navigator.userAgent.match(/Trident.*rv\:11\./);let o=!1;function d(){o=!0,window.addEventListener("mouseup",l)}function l(){window.removeEventListener("mouseup",l),o=!1,i&&setTimeout(i.bind(e),500)}function h(t){-1!=[37,38,39,40].indexOf(t.keyCode)&&(cancelAnimationFrame(r.id),r.last=performance.now(),r.id=requestAnimationFrame(c.bind(e,null,!0)))}function c(n,s){let d=performance.now()-r.last>a;if(t&&t.call(e),!d)return cancelAnimationFrame(r.id),void(r.id=requestAnimationFrame(c.bind(e,null,!0)));!o&&(n&&"change"==n.type||s)&&i&&i.call(e)}function u(){n.matches?(e.style.removeProperty("left"),e.style.removeProperty("width")):(e.style.left=e.parentNode.offsetWidth/2+"px",e.style.width=e.parentNode.offsetHeight+"px"),c()}!function(){let t=window.matchMedia("(orientation: portrait)");window.addEventListener("resize",u),window.addEventListener("load",u),t.addEventListener?t.addEventListener("change",u):t.addListener(u),s&&e.addEventListener("mousedown",d),e.addEventListener("input",c),e.addEventListener("change",c),e.addEventListener("keydown",h),e.addEventListener("touchstart",(function(){}),{passive:!0}),u()}()},window.InputNumber=function(e){const t=["input","keydown","keyup","mousedown","mouseup","select","contextmenu","drop"],i={value:null,start:null,end:null};function n(e){/^\d*$/.test(this.value)?(i.value=this.value,i.start=this.selectionStart,i.end=this.selectionEnd):null!==i.value?(this.value=i.value,this.setSelectionRange(i.start,i.end)):this.value=""}!function(){for(let i in t)e.addEventListener(t[i],n,!0)}()},window.Thumb=function(e){const t={startX:null,curX:null,edge:0},i=e.parentNode;return e.addEventListener("pointerdown",(function(e){window.addEventListener("pointermove",a,{passive:!0}),window.addEventListener("pointerup",r),a(e),t.startX=t.curX,n(),t.requestId=requestAnimationFrame(s)})),window.addEventListener("resize",n),n(),{update:n};function n(){t.parentRect=i.getBoundingClientRect(),t.edge=30/t.parentRect.width,o()}function a(e){t.curX=e.clientX}function r(e){window.removeEventListener("pointermove",a,{passive:!0}),window.removeEventListener("pointerup",r),cancelAnimationFrame(t.requestId)}function s(){var e;e||(e=(t.curX-t.parentRect.left)/t.parentRect.width,e=Math.max(Math.min(e,1-t.edge),t.edge)),comparison.divider=e,o(),t.requestId=requestAnimationFrame(s)}function o(){let i=comparison.divider*t.parentRect.width;e.style.transform="translate3d("+i+"px,0,0)",e.style.transform="translate("+i+"px,0)"}},window.ImageComparison=function(e,t){const i=function(e){const t=document.createElement("canvas"),i=t.getContext("2d",{alpha:!1});return t.width=2*e,t.height=2*e,i.fillStyle="#fff",i.fillRect(0,0,e,e),i.fillRect(e,e,e,e),i.fillStyle="#eee",i.fillRect(e,0,e,e),i.fillRect(0,e,e,e),i.createPattern(t,"repeat")}(10),n=e.getContext("2d"),a={startX:0,startY:0,currentX:0,currentY:0,width:0,height:0},r={original:null,optimized:null,x:0,y:0,width:0,height:0},s={draw:l,setImage:function(e,t){r.width!=t.naturalWidth&&(r.width=t.naturalWidth,r.x=a.width/2-r.width/2),r.height!=t.naturalHeight&&(r.height=t.naturalHeight,r.y=a.height/2-r.height/2),r[e]=t,l()},clear:function(){r.original=null,r.optimized=null,r.x=0,r.y=0,r.width=0,r.height=0,l()},resize:h,imageSmallerCanvas:!1};return window.addEventListener("resize",h),e.addEventListener("pointerdown",(function(e){window.addEventListener("pointerup",d),window.addEventListener("pointermove",o,{passive:!0}),r.startX=r.x,r.startY=r.y,a.startX=e.clientX,a.startY=e.clientY,l(!0)})),h(),s;function o(e){a.currentX=e.clientX,a.currentY=e.clientY;let t=r.startX+(a.currentX-a.startX),i=r.startY+(a.currentY-a.startY);r.width>a.width&&(r.x=Math.max(Math.min(t,0),a.width-r.width)),r.height>a.height&&(r.y=Math.max(Math.min(i,0),a.height-r.height))}function d(){window.removeEventListener("pointerup",d),window.removeEventListener("pointermove",o,{passive:!0}),cancelAnimationFrame(a.requestId)}function l(e){let o=a.width*comparison.divider;if(n.fillStyle=i,n.fillRect(0,0,a.width,a.height),o>=r.x&&r.original){let e=(o-r.x)/r.width,t=Math.min(r.width,r.width*e);n.drawImage(r.original,0,0,t,r.height,r.x,r.y,t,r.height)}if(o<=r.x+r.width&&r.optimized){let e=Math.max(o-r.x,0),t=1-e/r.width,i=Math.min(r.width,r.width*t),a=Math.max(o,r.x);n.drawImage(r.optimized,e,0,i,r.height,a,r.y,i,r.height)}e&&(a.requestId=requestAnimationFrame(l.bind(null,!0))),r.width>a.width||r.height>a.height?s.imageSmallerCanvas=!0:s.imageSmallerCanvas=!1,t&&t.call(s)}function h(){a.width==e.parentNode.offsetWidth&&a.height==e.parentNode.offsetHeight||(a.width=e.parentNode.offsetWidth,a.height=e.parentNode.offsetHeight,e.width=a.width,e.height=a.height,r.x=a.width/2-r.width/2,r.y=a.height/2-r.height/2,l())}};