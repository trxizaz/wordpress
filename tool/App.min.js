"use strict";!function(){const t=function(){const t=document.createElement("canvas"),e=t.getContext("2d",{alpha:!1});return t.width=10,t.height=10,e.fillStyle="#fff",e.fillRect(0,0,5,5),e.fillRect(5,5,5,5),e.fillStyle="#eee",e.fillRect(5,0,5,5),e.fillRect(0,5,5,5),e.createPattern(t,"repeat")}();window.App=function(e){const i={elem:function(t){const e=document.querySelector(t),i=e.innerText;return e.parentNode.removeChild(e),i}("#template-file")},n=document.querySelector("#filesSlot"),s=document.querySelector("#filesScroll"),o=[];let r=e.autoSettings;const l=new Bind({elem:document.querySelector("#app"),data:{list:[],sessionId:f(),isUploading:!1,isProcessing:!1,convertParams:e.convertParams||{},prevDisabled:!0,nextDisabled:!0,activeItem:null},computed:{counter:function(){return this.list.filter((function(t){return t.processed})).length},downloadDisabled:function(){return!this.counter||this.list.some((function(t){return t.processing}))}},methods:{add:function(t){const n=this.check(t);!0===n?this.list.length<=e.maxLength&&(this.list.push(function(t){return new Bind({template:i.elem,data:{file:t,id:f(26,"file_"),thumbnail_src:"",percent:0,status:"init",processing:!1,processed:!1,uploaded:!1,error:null,active:!1},computed:{name:function(){return this.file.name},fitted_name:function(){const t=this.elem.querySelector(".file__title");return t&&0!=t.offsetWidth?function(t,e){const i=7,n=document.createElement("canvas").getContext("2d",{alpha:!1}),s=window.getComputedStyle(e),o=e.offsetWidth;let r,l,c=0,a=0;if(n.font=s.getPropertyValue("font-weight")+" "+s.getPropertyValue("font-size")+" "+s.getPropertyValue("font-family"),r=n.measureText(t).width,r<=o)return t;t=[t.slice(0,-i),t.slice(-i)],l=n.measureText(t[1]).width;for(;c+l<o;)a+=1,c=n.measureText(t[0].slice(0,a)+"…").width;return t[0].slice(0,a-1)+"…"+t[1]}(this.name,t):this.name},size:function(){return this.file.size},human_size:function(){return function(t){let e=Math.floor(Math.log(t)/Math.log(1024));return 1*(t/Math.pow(1024,e)).toFixed(2==e?1:0)+" "+["B","KB","MB"][e]}(this.file.size)},elem_process:function(){return this.processing||"waiting"==this.status||"init"==this.status},url:function(){const t=["bmp","gif","jpeg","png","vnd.microsoft.icon","x-icon"];let i=this.file.type.split("/")[1].split(";")[0];return e.clientImages&&-1!=t.indexOf(i)?URL.createObjectURL(this.file):this.response?e.origin+this.response.original_url.slice(1):""},savings:function(){return this.response&&this.response.savings||""}},methods:{remove:function(){l.remove(this)},onUploaded:function(t){this.status="waiting"},onProcessed:function(t){this.response=t,this._compute("savings"),this._compute("url"),this.thumbnail_correct&&(this.status="processed")},download:function(){if(!this.response)return;let t=this.response.result;d(e.origin+"download/"+l.sessionId+"/"+this.id+"/"+t,t)},repeat:function(){this.uploaded?this.processed||(this.status="uploaded",l.isProcessing||a()):(this.status="init",l.isUploading||a())},setActive:function(){app.setActive(this)}},mounted:function(){this._compute("fitted_name"),u(this.url,this.elem.offsetWidth,function(t,e){e||(this.thumbnail_correct=!0),this.thumbnail_src=t}.bind(this)),a()},watch:{processing:function(t){t&&(this.uploaded?this.processed||(this.status="processing"):this.status="uploading")},error:function(t){t&&(this.status="error")},status:function(t){"error"!=t&&(this.error=null)}}})}(t)),c(1/0)):"string"==typeof n&&appText[n]?this.notify(appText[n],"type"==n&&e.formats.join(", ")):this.notify(appText.error,t.name)},check:function(t){let i=t.name.split(".").pop().toLowerCase();return-1==(e.formats||[]).map((function(t){return t.toLowerCase()})).indexOf(i)?"type":!(e.maxSize<t.size)||"size"},remove:function(t){this.abort(t);for(let e in this.list)if(this.list[e]==t){this.list.splice(e,1);break}t==this.activeItem&&this.setActive(),this.onScroll()},clear:function(){for(let t=0,e=this.list.length;t<e;t++)this.remove(this.list[0]);this.isUploading=!1,this.isProcessing=!1},download:function(){let t=e.allName,i=this.list.filter((function(t){return t.processed})).map((function(t){return t.id}));d(e.origin+"all/"+l.sessionId+"/"+t+"?order="+i.join(",")+"&rnd="+Math.random(),t)},scrollNext:function(){c("next")},scrollPrev:function(){c("prev")},onScroll:function(){s.scrollLeft<=0?this.prevDisabled=!0:this.prevDisabled=!1,s.scrollLeft>=s.scrollWidth-s.offsetWidth?this.nextDisabled=!0:this.nextDisabled=!1},setOrder:function(t){let e=[0,this.list.length];for(let i=0,n=t.length;i<n;i++){let n=t[i];e.push(this.list[n])}Array.prototype.splice.apply(this.list,e)},setActive:function(t){if(e.settings&&"undefined"!=typeof comparison&&comparison){if(t)if("error"==t.status){if(!t.processed)return}else if("processed"!=t.status)return;t||(this.activeItem=null);for(let e in this.list){let i=this.list[e];i==t?(i.active=!0,this.activeItem=i):i.active=!1}this.activeItem&&(this.activeItem.status="processed")}},notify:function(t,e){e&&(t+=" <b>"+e+"</b>"),new Notice(t)},upload:function(t){let i=e.origin+"upload/"+this.sessionId;return t.processing=!0,t.percent=0,t.ajax=new Ajax("POST",i,{type:"formData",data:{file:t.file,id:t.id,name:t.name}}).onProgress((function(e){t.percent=Math.ceil(100*e)})).onLoad((function(e){t.percent=100,t.uploaded=!0,t.onUploaded(e)})).onError((function(e){t.error=e,t.uploaded=!1,"abort"!=e&&app.notify(appText.error,t.name)})).onFinal((function(){t.processing=!1,t.ajax=null})),t.ajax},process:function(t,i){let n=e.origin+i+"/"+this.sessionId+"/"+t.id;return t.processing=!0,t.percent=0,this._compute("downloadDisabled"),t.ajax=new Ajax("GET",n,{progress:{key:i+"_progress",url:n.replace("/"+i+"/","/status/")},data:this.convertParams}).onProgress((function(e){t.percent=e})).onLoad((function(i){t.percent=100,t.processed=!0,t.onProcessed(i),t.thumbnail_correct?r&&"processed"==t.status&&(r=!1,t.setActive()):u(e.origin+i.thumb_url.slice(1),t.elem.offsetWidth,(function(e,i){i||(t.thumbnail_correct=!0),t.thumbnail_src=e,t.status="processed",r&&(r=!1,t.setActive())}))})).onError((function(e){t.error=e,"abort"!=e&&app.notify(appText.error,t.name)})).onFinal(function(){t.processing=!1,t.ajax=null,this._compute("downloadDisabled")}.bind(this)),t.ajax},preview:function(t){let i=e.origin+"compress/"+this.sessionId+"/"+t.id;return new Ajax("GET",i,{progress:{key:"compress_progress",url:i.replace("/compress/","/status/")},data:this.convertParams}).onError((function(e){"abort"!=e&&app.notify(appText.error,t.name)}))},abort:function(t){return t.ajax&&t.ajax.abort(),t.ajax},onResize:function(){if(this.onScroll(),!this.list.length||!this.activeItem)return;let t=n.offsetLeft,e=this.activeItem.elem.offsetLeft,i=e+this.activeItem.elem.offsetWidth,o=s.offsetWidth,r=s.scrollLeft;e<r?s.scrollLeft=e:i>r+o-2*t&&(s.scrollLeft=i-o+2*t)}},mounted:function(){window.addEventListener("resize",this.onResize.bind(this))},watch:{list:function(){const t=Array.prototype.slice.call(n.children);for(let e in l.list){let i=l.list[e],s=t.indexOf(i.elem);-1!=s&&t.splice(s,1),n.appendChild(i.elem)}for(let e in t){let i=t[e];i.parentNode.removeChild(i)}l.list.length||(r=e.autoSettings)},activeItem:function(t,e){t?t!=e&&(comparison.item=t):comparison.item=null}}});return l;function c(t){let e=n.parentNode;"prev"!=t&&"next"!=t||(t=function(t,e){let i=e.offsetWidth,s=e.scrollLeft,o=n.offsetLeft;if("prev"==t){return r(s-i+o).offsetLeft||0}{let t=r(s+i-2*o);return t=t||{offsetLeft:1/0},Math.min(t.offsetLeft,e.scrollWidth-i)}function r(t){let e=Array.prototype.slice.call(n.children);for(let i in e){let n=e[i];if(n.offsetLeft>=t)return n}return null}}(t,e)),new SmoothScroll(e).scrollTo(t,500)}function a(){if(l._compute("counter"),l._compute("downloadDisabled"),!l.isUploading||!l.isProcessing){for(let t in l.list){let e=l.list[t];e.error||e.processed||(l.isUploading||e.uploaded?l.isProcessing||e.processed||!e.uploaded||(l.isProcessing=!0,l.process(e,"auto").onFinal((function(){l.isProcessing=!1,a()}))):(l.isUploading=!0,l.upload(e).onLoad((function(t){e.percent=0})).onFinal((function(){l.isUploading=!1,a()}))))}l._compute("downloadDisabled")}}function u(e,i,n){const s=document.createElement("canvas"),o=s.getContext("2d");let r=new Image,l=window.devicePixelRatio;function c(){n(s.toDataURL(),"Error")}r.addEventListener("load",(function(){const t=r.naturalHeight,e=r.naturalWidth,l=(e-t)/2,c=(t-e)/2;let a,u,f,d,p=0,h=0,m=i,g=i;Math.max(t,e)/Math.min(t,e)>2.5?(a=0,u=0,d=t,f=e,m=t>e?i/(t/e):i,g=e>t?i/(e/t):i,p=(i-m)/2,h=(i-g)/2):(a=t>e?0:l,u=t>e?c:0,f=t>e?e:t,d=f);o.drawImage(r,a,u,f,d,p,h,m,g),n(s.toDataURL())})),r.addEventListener("error",c),i*=l,s.width=i,s.height=i,o.scale(l,l),o.fillStyle=t,o.fillRect(0,0,i,i),o.scale(1/l,1/l),e?r.src=e:c()}function f(t,e){t=t||16,e=e||"";let i="";for(;i.length<t;)i+=Math.floor(65535*Math.random()).toString(32);return i=e+i.slice(0,t),-1!=o.indexOf(i)?f(t,e):(o.push(i),i)}function d(t,e){const i=document.createElement("a");i.href=t,i.target="_blank",i.download=e,i.style.display="none",document.body.appendChild(i),i.click(),requestAnimationFrame((function(){document.body.removeChild(i)}))}}}();